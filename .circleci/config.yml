# WARNING: DO NOT EDIT THIS FILE DIRECTLY!!!
# See the README.md in this directory.

# IMPORTANT: To update Docker image version, please first update
# https://github.com/pytorch/ossci-job-dsl/blob/master/src/main/groovy/ossci/pytorch/DockerVersion.groovy and
# https://github.com/pytorch/ossci-job-dsl/blob/master/src/main/groovy/ossci/caffe2/DockerVersion.groovy,
# and then update DOCKER_IMAGE_VERSION at the top of the following files:
# * cimodel/data/pytorch_build_definitions.py
# * cimodel/data/caffe2_build_definitions.py
# And the inline copies of the variable in
# * verbatim-sources/job-specs-custom.yml
#   (grep for DOCKER_IMAGE)

docker_config_defaults: &docker_config_defaults
  user: jenkins
  aws_auth:
    # This IAM user only allows read-write access to ECR
    aws_access_key_id: ${CIRCLECI_AWS_ACCESS_KEY_FOR_ECR_READ_WRITE_V4}
    aws_secret_access_key: ${CIRCLECI_AWS_SECRET_KEY_FOR_ECR_READ_WRITE_V4}

# This system setup script is meant to run before the CI-related scripts, e.g.,
# installing Git client, checking out code, setting up CI env, and
# building/testing.
setup_linux_system_environment: &setup_linux_system_environment
  name: Set Up System Environment
  no_output_timeout: "1h"
  command: ~/workspace/.circleci/scripts/setup_linux_system_environment.sh

# NB: This (and the command below) must be run after attaching
# ~/workspace.  This is NOT the default working directory (that's
# ~/project); this workspace is generated by the setup job.
should_run_job: &should_run_job
  name: Should Run Job After attach_workspace
  no_output_timeout: "2m"
  command: ~/workspace/.circleci/scripts/should_run_job.sh

setup_ci_environment: &setup_ci_environment
  name: Set Up CI Environment After attach_workspace
  no_output_timeout: "1h"
  command: ~/workspace/.circleci/scripts/setup_ci_environment.sh

# Installs expect and moreutils so that we can call `unbuffer` and `ts`.
# Also installs OpenMP
# !!!!NOTE!!!! this is copied into a binary_macos_brew_update job which is the
# same but does not install libomp. If you are changing this, consider if you
# need to change that step as well.
macos_brew_update: &macos_brew_update
  name: Brew update and install moreutils, expect and libomp
  no_output_timeout: "1h"
  command: |
    set -ex
    # See https://discourse.brew.sh/t/fetching-homebrew-repos-is-slow/5374/3
    brew untap caskroom/homebrew-cask
    # moreutils installs a `parallel` executable by default, which conflicts
    # with the executable from the GNU `parallel`, so we must unlink GNU
    # `parallel` first, and relink it afterwards
    brew update
    brew unlink parallel
    brew install moreutils
    brew link parallel --overwrite
    brew install expect
    brew install libomp



##############################################################################
# Linux build defaults
##############################################################################

pytorch_linux_build_defaults: &pytorch_linux_build_defaults
  resource_class: large
  machine:
    image: ubuntu-1604:201903-01
  steps:
  # See Note [Workspace for CircleCI scripts] in job-specs-setup.yml
  - attach_workspace:
      at: ~/workspace
  - run:
      <<: *should_run_job
  - run:
      <<: *setup_linux_system_environment
  - checkout
  - run:
      <<: *setup_ci_environment
  - run:
      name: Build
      no_output_timeout: "1h"
      command: |
        set -e
        # Pull Docker image and run build
        echo "DOCKER_IMAGE: "${DOCKER_IMAGE}
        docker pull ${DOCKER_IMAGE} >/dev/null
        export id=$(docker run -t -d -w /var/lib/jenkins ${DOCKER_IMAGE})

        git submodule sync && git submodule update -q --init --recursive

        docker cp /home/circleci/project/. $id:/var/lib/jenkins/workspace

        if [[ ${BUILD_ENVIRONMENT} == *"namedtensor"* ]]; then
          NAMED_FLAG="export BUILD_NAMEDTENSOR=1"
        fi

        export COMMAND='((echo "export BUILD_ENVIRONMENT=${BUILD_ENVIRONMENT}" && echo '"$NAMED_FLAG"' && echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && .jenkins/pytorch/build.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
        echo ${COMMAND} > ./command.sh && unbuffer bash ./command.sh | ts

        # Push intermediate Docker image for next phase to use
        if [ -z "${BUILD_ONLY}" ]; then
          # Note [Special build images]
          # The namedtensor and xla builds use the same docker image as
          # pytorch-linux-trusty-py3.6-gcc5.4-build. In the push step, we have to
          # distinguish between them so the test can pick up the correct image.
          output_image=${DOCKER_IMAGE}-${CIRCLE_SHA1}
          if [[ ${BUILD_ENVIRONMENT} == *"namedtensor"* ]]; then
            export COMMIT_DOCKER_IMAGE=$output_image-namedtensor
          elif [[ ${BUILD_ENVIRONMENT} == *"xla"* ]]; then
            export COMMIT_DOCKER_IMAGE=$output_image-xla
          else
            export COMMIT_DOCKER_IMAGE=$output_image
          fi
          docker commit "$id" ${COMMIT_DOCKER_IMAGE}
          docker push ${COMMIT_DOCKER_IMAGE}
        fi

pytorch_linux_test_defaults: &pytorch_linux_test_defaults
  machine:
    image: ubuntu-1604:201903-01
  steps:
  # See Note [Workspace for CircleCI scripts] in job-specs-setup.yml
  - attach_workspace:
      at: ~/workspace
  - run:
      <<: *should_run_job
  - run:
      <<: *setup_linux_system_environment
  - run:
      <<: *setup_ci_environment
  - run:
      name: Test
      no_output_timeout: "90m"
      command: |
        set -e
        # See Note [Special build images]
        output_image=${DOCKER_IMAGE}-${CIRCLE_SHA1}
        if [[ ${BUILD_ENVIRONMENT} == *"namedtensor"* ]]; then
          export COMMIT_DOCKER_IMAGE=$output_image-namedtensor
          NAMED_FLAG="export BUILD_NAMEDTENSOR=1"
        elif [[ ${BUILD_ENVIRONMENT} == *"xla"* ]]; then
          export COMMIT_DOCKER_IMAGE=$output_image-xla
        else
          export COMMIT_DOCKER_IMAGE=$output_image
        fi
        echo "DOCKER_IMAGE: "${COMMIT_DOCKER_IMAGE}
        docker pull ${COMMIT_DOCKER_IMAGE} >/dev/null
        if [ -n "${USE_CUDA_DOCKER_RUNTIME}" ]; then
          export id=$(docker run --runtime=nvidia -t -d -w /var/lib/jenkins ${COMMIT_DOCKER_IMAGE})
        else
          export id=$(docker run -t -d -w /var/lib/jenkins ${COMMIT_DOCKER_IMAGE})
        fi
        if [ -n "${MULTI_GPU}" ]; then
          export COMMAND='((echo "export BUILD_ENVIRONMENT=${BUILD_ENVIRONMENT}" && echo '"$NAMED_FLAG"' && echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && .jenkins/pytorch/multigpu-test.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
        else
          export COMMAND='((echo "export BUILD_ENVIRONMENT=${BUILD_ENVIRONMENT}" && echo '"$NAMED_FLAG"'&& echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && .jenkins/pytorch/test.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
        fi
        echo ${COMMAND} > ./command.sh && unbuffer bash ./command.sh | ts

caffe2_linux_build_defaults: &caffe2_linux_build_defaults
  resource_class: large
  machine:
    image: ubuntu-1604:201903-01
  steps:
  # See Note [Workspace for CircleCI scripts] in job-specs-setup.yml
  - attach_workspace:
      at: ~/workspace
  - run:
      <<: *should_run_job
  - run:
      <<: *setup_linux_system_environment
  - checkout
  - run:
      <<: *setup_ci_environment
  - run:
      name: Build
      no_output_timeout: "1h"
      command: |
        set -e
        cat >/home/circleci/project/ci_build_script.sh <<EOL
        # =================== The following code will be executed inside Docker container ===================
        set -ex
        export BUILD_ENVIRONMENT="$BUILD_ENVIRONMENT"

        # Reinitialize submodules
        git submodule sync && git submodule update -q --init --recursive

        # conda must be added to the path for Anaconda builds (this location must be
        # the same as that in install_anaconda.sh used to build the docker image)
        if [[ "${BUILD_ENVIRONMENT}" == conda* ]]; then
          export PATH=/opt/conda/bin:$PATH
          sudo chown -R jenkins:jenkins '/opt/conda'
        fi

        # Build
        ./.jenkins/caffe2/build.sh

        # Show sccache stats if it is running
        if pgrep sccache > /dev/null; then
          sccache --show-stats
        fi
        # =================== The above code will be executed inside Docker container ===================
        EOL
        chmod +x /home/circleci/project/ci_build_script.sh

        echo "DOCKER_IMAGE: "${DOCKER_IMAGE}
        docker pull ${DOCKER_IMAGE} >/dev/null
        export id=$(docker run -t -d -w /var/lib/jenkins ${DOCKER_IMAGE})
        docker cp /home/circleci/project/. $id:/var/lib/jenkins/workspace

        export COMMAND='((echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && ./ci_build_script.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
        echo ${COMMAND} > ./command.sh && unbuffer bash ./command.sh | ts

        # Push intermediate Docker image for next phase to use
        if [ -z "${BUILD_ONLY}" ]; then
          if [[ "$BUILD_ENVIRONMENT" == *cmake* ]]; then
            export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-cmake-${CIRCLE_SHA1}
          else
            export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-${CIRCLE_SHA1}
          fi
          docker commit "$id" ${COMMIT_DOCKER_IMAGE}
          docker push ${COMMIT_DOCKER_IMAGE}
        fi

caffe2_linux_test_defaults: &caffe2_linux_test_defaults
  machine:
    image: ubuntu-1604:201903-01
  steps:
  # See Note [Workspace for CircleCI scripts] in job-specs-setup.yml
  - attach_workspace:
      at: ~/workspace
  - run:
      <<: *setup_linux_system_environment
  - run:
      <<: *should_run_job
  - run:
      <<: *setup_ci_environment
  - run:
      name: Test
      no_output_timeout: "1h"
      command: |
        set -e
        # TODO: merge this into Caffe2 test.sh
        cat >/home/circleci/project/ci_test_script.sh <<EOL
        # =================== The following code will be executed inside Docker container ===================
        set -ex

        export BUILD_ENVIRONMENT="$BUILD_ENVIRONMENT"

        # libdc1394 (dependency of OpenCV) expects /dev/raw1394 to exist...
        sudo ln /dev/null /dev/raw1394

        # conda must be added to the path for Anaconda builds (this location must be
        # the same as that in install_anaconda.sh used to build the docker image)
        if [[ "${BUILD_ENVIRONMENT}" == conda* ]]; then
          export PATH=/opt/conda/bin:$PATH
        fi

        # Upgrade SSL module to avoid old SSL warnings
        pip -q install --user --upgrade pyOpenSSL ndg-httpsclient pyasn1

        pip -q install --user -b /tmp/pip_install_onnx "file:///var/lib/jenkins/workspace/third_party/onnx#egg=onnx"

        # Build
        ./.jenkins/caffe2/test.sh

        # Remove benign core dumps.
        # These are tests for signal handling (including SIGABRT).
        rm -f ./crash/core.fatal_signal_as.*
        rm -f ./crash/core.logging_test.*
        # =================== The above code will be executed inside Docker container ===================
        EOL
        chmod +x /home/circleci/project/ci_test_script.sh

        if [[ "$BUILD_ENVIRONMENT" == *cmake* ]]; then
          export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-cmake-${CIRCLE_SHA1}
        else
          export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-${CIRCLE_SHA1}
        fi
        echo "DOCKER_IMAGE: "${COMMIT_DOCKER_IMAGE}
        docker pull ${COMMIT_DOCKER_IMAGE} >/dev/null
        if [ -n "${USE_CUDA_DOCKER_RUNTIME}" ]; then
          export id=$(docker run --runtime=nvidia -t -d -w /var/lib/jenkins ${COMMIT_DOCKER_IMAGE})
        else
          export id=$(docker run -t -d -w /var/lib/jenkins ${COMMIT_DOCKER_IMAGE})
        fi
        docker cp /home/circleci/project/. "$id:/var/lib/jenkins/workspace"

        export COMMAND='((echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && ./ci_test_script.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
        echo ${COMMAND} > ./command.sh && unbuffer bash ./command.sh | ts

##############################################################################
# Job specifications job specs
##############################################################################
version: 2
jobs:
  pytorch_linux_trusty_py2_7_9_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py2.7.9-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py2.7.9:327"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py2_7_9_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py2.7.9-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py2.7.9:327"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_py2_7_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py2.7-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py2.7:327"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py2_7_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py2.7-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py2.7:327"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_py3_5_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py3.5-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.5:327"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py3_5_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py3.5-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.5:327"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_pynightly_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-pynightly-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-pynightly:327"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_pynightly_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-pynightly-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-pynightly:327"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_py3_6_gcc4_8_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py3.6-gcc4.8-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc4.8:327"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py3_6_gcc4_8_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py3.6-gcc4.8-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc4.8:327"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_py3_6_gcc5_4_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py3.6-gcc5.4-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc5.4:327"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py3_6_gcc5_4_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py3.6-gcc5.4-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc5.4:327"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_xla_linux_trusty_py3_6_gcc5_4_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-xla-linux-trusty-py3.6-gcc5.4-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc5.4:327"
    <<: *pytorch_linux_build_defaults

  pytorch_xla_linux_trusty_py3_6_gcc5_4_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-xla-linux-trusty-py3.6-gcc5.4-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc5.4:327"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_namedtensor_linux_trusty_py3_6_gcc5_4_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-namedtensor-linux-trusty-py3.6-gcc5.4-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc5.4:327"
    <<: *pytorch_linux_build_defaults

  pytorch_namedtensor_linux_trusty_py3_6_gcc5_4_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-namedtensor-linux-trusty-py3.6-gcc5.4-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc5.4:327"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_py3_6_gcc7_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py3.6-gcc7-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc7:327"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py3_6_gcc7_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-trusty-py3.6-gcc7-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc7:327"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_py3_clang5_asan_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-py3-clang5-asan-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-py3-clang5-asan:327"
      PYTHON_VERSION: "3.6"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_xenial_py3_clang5_asan_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-py3-clang5-asan-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-py3-clang5-asan:327"
      PYTHON_VERSION: "3.6"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_namedtensor_linux_xenial_py3_clang5_asan_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-namedtensor-linux-xenial-py3-clang5-asan-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-py3-clang5-asan:327"
      PYTHON_VERSION: "3.6"
    <<: *pytorch_linux_build_defaults

  pytorch_namedtensor_linux_xenial_py3_clang5_asan_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-namedtensor-linux-xenial-py3-clang5-asan-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-py3-clang5-asan:327"
      PYTHON_VERSION: "3.6"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py2_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda9-cudnn7-py2-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py2:327"
      PYTHON_VERSION: "2.7"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py2_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda9-cudnn7-py2-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py2:327"
      PYTHON_VERSION: "2.7"
      USE_CUDA_DOCKER_RUNTIME: "1"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py3_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda9-cudnn7-py3-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py3:327"
      PYTHON_VERSION: "3.6"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py3_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda9-cudnn7-py3-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py3:327"
      PYTHON_VERSION: "3.6"
      USE_CUDA_DOCKER_RUNTIME: "1"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py3_multigpu_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda9-cudnn7-py3-multigpu-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py3:327"
      PYTHON_VERSION: "3.6"
      USE_CUDA_DOCKER_RUNTIME: "1"
      MULTI_GPU: "1"
    resource_class: gpu.large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py3_NO_AVX2_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda9-cudnn7-py3-NO_AVX2-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py3:327"
      PYTHON_VERSION: "3.6"
      USE_CUDA_DOCKER_RUNTIME: "1"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py3_NO_AVX_NO_AVX2_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda9-cudnn7-py3-NO_AVX-NO_AVX2-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py3:327"
      PYTHON_VERSION: "3.6"
      USE_CUDA_DOCKER_RUNTIME: "1"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py3_slow_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda9-cudnn7-py3-slow-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py3:327"
      PYTHON_VERSION: "3.6"
      USE_CUDA_DOCKER_RUNTIME: "1"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py3_nogpu_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda9-cudnn7-py3-nogpu-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py3:327"
      PYTHON_VERSION: "3.6"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_namedtensor_linux_xenial_cuda9_cudnn7_py2_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-namedtensor-linux-xenial-cuda9-cudnn7-py2-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py2:327"
      PYTHON_VERSION: "2.7"
    <<: *pytorch_linux_build_defaults

  pytorch_namedtensor_linux_xenial_cuda9_cudnn7_py2_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-namedtensor-linux-xenial-cuda9-cudnn7-py2-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py2:327"
      PYTHON_VERSION: "2.7"
      USE_CUDA_DOCKER_RUNTIME: "1"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda9_2_cudnn7_py3_gcc7_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda9.2-cudnn7-py3-gcc7-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9.2-cudnn7-py3-gcc7:327"
      PYTHON_VERSION: "3.6"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_xenial_cuda9_2_cudnn7_py3_gcc7_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda9.2-cudnn7-py3-gcc7-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9.2-cudnn7-py3-gcc7:327"
      PYTHON_VERSION: "3.6"
      USE_CUDA_DOCKER_RUNTIME: "1"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda10_cudnn7_py3_gcc7_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda10-cudnn7-py3-gcc7-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda10-cudnn7-py3-gcc7:327"
      PYTHON_VERSION: "3.6"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_xenial_cuda10_1_cudnn7_py3_gcc7_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda10.1-cudnn7-py3-gcc7-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda10.1-cudnn7-py3-gcc7:327"
      PYTHON_VERSION: "3.6"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_xenial_cuda10_1_cudnn7_py3_gcc7_test:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-cuda10.1-cudnn7-py3-gcc7-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda10.1-cudnn7-py3-gcc7:327"
      PYTHON_VERSION: "3.6"
      USE_CUDA_DOCKER_RUNTIME: "1"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_py3_clang5_android_ndk_r19c_build:
    environment:
      BUILD_ENVIRONMENT: pytorch-linux-xenial-py3-clang5-android-ndk-r19c-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-py3-clang5-android-ndk-r19c:327"
      PYTHON_VERSION: "3.6"
    <<: *pytorch_linux_build_defaults

  
  setup:
    docker:
      - image: circleci/python:3.7.3
    steps:
      - checkout
      - run:
          name: Ensure config is up to date
          command: ./ensure-consistency.py
          working_directory: .circleci
      - run:
          name: Save commit message
          command: git log --format='%B' -n 1 HEAD > .circleci/scripts/COMMIT_MSG
      # Note [Workspace for CircleCI scripts]
      # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      # In the beginning, you wrote your CI scripts in a
      # .circleci/config.yml file, and life was good.  Your CI
      # configurations flourished and multiplied.
      #
      # Then one day, CircleCI cometh down high and say, "Your YAML file
      # is too biggeth, it stresses our servers so."  And thus they
      # asketh us to smite the scripts in the yml file.
      #
      # But you can't just put the scripts in the .circleci folder,
      # because in some jobs, you don't ever actually checkout the
      # source repository.  Where you gonna get the scripts from?
      #
      # Here's how you do it: you persist .circleci/scripts into a
      # workspace, attach the workspace in your subjobs, and run all
      # your scripts from there.
      - persist_to_workspace:
          root: .
          paths: .circleci/scripts

  caffe2_onnx_py2_gcc5_ubuntu16_04_build:
    environment:
      BUILD_ENVIRONMENT: "caffe2-onnx-py2-gcc5-ubuntu16.04-build"
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-gcc5-ubuntu16.04:287"
    <<: *caffe2_linux_build_defaults

  caffe2_onnx_py2_gcc5_ubuntu16_04_test:
    environment:
      BUILD_ENVIRONMENT: "caffe2-onnx-py2-gcc5-ubuntu16.04-test"
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-gcc5-ubuntu16.04:287"
    resource_class: large
    <<: *caffe2_linux_test_defaults

  caffe2_py2_clang7_ubuntu16_04_build:
    environment:
      BUILD_ENVIRONMENT: "caffe2-py2-clang7-ubuntu16.04-build"
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-clang7-ubuntu16.04:287"
      BUILD_ONLY: "1"
    <<: *caffe2_linux_build_defaults

  caffe2_onnx_py3_6_clang7_ubuntu16_04_build:
    environment:
      BUILD_ENVIRONMENT: "caffe2-onnx-py3.6-clang7-ubuntu16.04-build"
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py3.6-clang7-ubuntu16.04:287"
    <<: *caffe2_linux_build_defaults

  caffe2_onnx_py3_6_clang7_ubuntu16_04_test:
    environment:
      BUILD_ENVIRONMENT: "caffe2-onnx-py3.6-clang7-ubuntu16.04-test"
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py3.6-clang7-ubuntu16.04:287"
    resource_class: large
    <<: *caffe2_linux_test_defaults

  binary_linux_manywheel_2.7m_cpu_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 2.7m cpu devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7mu_cpu_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 2.7mu cpu devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_3.5m_cpu_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 3.5m cpu devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_3.6m_cpu_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 3.6m cpu devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_3.7m_cpu_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 3.7m cpu devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7m_cu92_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 2.7m cu92 devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda92"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7mu_cu92_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 2.7mu cu92 devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda92"
    <<: *binary_linux_build

  binary_linux_manywheel_3.5m_cu92_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 3.5m cu92 devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda92"
    <<: *binary_linux_build

  binary_linux_manywheel_3.6m_cu92_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 3.6m cu92 devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda92"
    <<: *binary_linux_build

  binary_linux_manywheel_3.7m_cu92_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 3.7m cu92 devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda92"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7m_cu100_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 2.7m cu100 devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7mu_cu100_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 2.7mu cu100 devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_3.5m_cu100_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 3.5m cu100 devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_3.6m_cu100_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 3.6m cu100 devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_3.7m_cu100_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "manywheel 3.7m cu100 devtoolset7"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_conda_2.7_cpu_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 2.7 cpu devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.5_cpu_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.5 cpu devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.6_cpu_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.6 cpu devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.7_cpu_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.7 cpu devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_2.7_cu92_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 2.7 cu92 devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.5_cu92_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.5 cu92 devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.6_cu92_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.6 cu92 devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.7_cu92_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.7 cu92 devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_2.7_cu100_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 2.7 cu100 devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.5_cu100_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.5 cu100 devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.6_cu100_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.6 cu100 devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.7_cu100_devtoolset7_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.7 cu100 devtoolset7"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cpu_devtoolset7_shared-with-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cpu devtoolset7"
      LIBTORCH_VARIANT: "shared-with-deps"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cpu_devtoolset7_shared-without-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cpu devtoolset7"
      LIBTORCH_VARIANT: "shared-without-deps"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cpu_devtoolset7_static-with-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cpu devtoolset7"
      LIBTORCH_VARIANT: "static-with-deps"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cpu_devtoolset7_static-without-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cpu devtoolset7"
      LIBTORCH_VARIANT: "static-without-deps"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cu92_devtoolset7_shared-with-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cu92 devtoolset7"
      LIBTORCH_VARIANT: "shared-with-deps"
    docker:
      - image: "soumith/manylinux-cuda92"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cu92_devtoolset7_shared-without-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cu92 devtoolset7"
      LIBTORCH_VARIANT: "shared-without-deps"
    docker:
      - image: "soumith/manylinux-cuda92"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cu92_devtoolset7_static-with-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cu92 devtoolset7"
      LIBTORCH_VARIANT: "static-with-deps"
    docker:
      - image: "soumith/manylinux-cuda92"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cu92_devtoolset7_static-without-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cu92 devtoolset7"
      LIBTORCH_VARIANT: "static-without-deps"
    docker:
      - image: "soumith/manylinux-cuda92"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cu100_devtoolset7_shared-with-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cu100 devtoolset7"
      LIBTORCH_VARIANT: "shared-with-deps"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cu100_devtoolset7_shared-without-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cu100 devtoolset7"
      LIBTORCH_VARIANT: "shared-without-deps"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cu100_devtoolset7_static-with-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cu100 devtoolset7"
      LIBTORCH_VARIANT: "static-with-deps"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cu100_devtoolset7_static-without-deps_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7m cu100 devtoolset7"
      LIBTORCH_VARIANT: "static-without-deps"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_macos_wheel_2.7_cpu_build:
    environment:
      BUILD_ENVIRONMENT: "wheel 2.7 cpu"
    <<: *binary_mac_build

  binary_macos_wheel_3.5_cpu_build:
    environment:
      BUILD_ENVIRONMENT: "wheel 3.5 cpu"
    <<: *binary_mac_build

  binary_macos_wheel_3.6_cpu_build:
    environment:
      BUILD_ENVIRONMENT: "wheel 3.6 cpu"
    <<: *binary_mac_build

  binary_macos_wheel_3.7_cpu_build:
    environment:
      BUILD_ENVIRONMENT: "wheel 3.7 cpu"
    <<: *binary_mac_build

  binary_macos_conda_2.7_cpu_build:
    environment:
      BUILD_ENVIRONMENT: "conda 2.7 cpu"
    <<: *binary_mac_build

  binary_macos_conda_3.5_cpu_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.5 cpu"
    <<: *binary_mac_build

  binary_macos_conda_3.6_cpu_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.6 cpu"
    <<: *binary_mac_build

  binary_macos_conda_3.7_cpu_build:
    environment:
      BUILD_ENVIRONMENT: "conda 3.7 cpu"
    <<: *binary_mac_build

  binary_macos_libtorch_2.7_cpu_build:
    environment:
      BUILD_ENVIRONMENT: "libtorch 2.7 cpu"
    <<: *binary_mac_build


##############################################################################
##############################################################################
# Workflows
##############################################################################
##############################################################################

# PR jobs pr builds
workflows:
  version: 2
  build:
    jobs:
      - caffe2_onnx_py2_gcc5_ubuntu16_04_build:
          requires:
            - setup
      - caffe2_onnx_py2_gcc5_ubuntu16_04_test:
          requires:
            - setup
            - caffe2_onnx_py2_gcc5_ubuntu16_04_build
      - caffe2_py2_clang7_ubuntu16_04_build:
          requires:
            - setup
      - caffe2_onnx_py3_6_clang7_ubuntu16_04_build:
          requires:
            - setup
      - caffe2_onnx_py3_6_clang7_ubuntu16_04_test:
          requires:
            - setup
            - caffe2_onnx_py3_6_clang7_ubuntu16_04_build
